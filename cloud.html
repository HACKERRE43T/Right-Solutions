<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Right Cloud: Dominance Protocol</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom styles for Inter font and general body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d0d1a; /* Very dark background */
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top for better content flow */
            min-height: 100vh;
            padding: 20px;
            box-sizing: border-box;
            color: #e0e0e0; /* Light text color */
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb {
            background: #8a2be2; /* Electric purple */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6a0dad;
        }
        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1a1a2e; /* Dark modal background */
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(138, 43, 226, 0.5); /* Purple glow */
            width: 90%;
            max-width: 900px; /* Wider for more info */
            position: relative;
            border: 1px solid #8a2be2; /* Purple border */
        }
        .close-button {
            color: #e94560; /* Red for close */
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ff0000; /* Brighter red on hover */
            text-decoration: none;
            cursor: pointer;
        }
        /* Input and Button styles for villain theme */
        input[type="text"], input[type="password"] {
            background-color: #0f0f23 !important; /* Even darker input background */
            border: 1px solid #8a2be2 !important; /* Purple border */
            color: #e0e0e0 !important; /* Light text */
            box-shadow: 0 0 5px rgba(138, 43, 226, 0.3); /* Subtle glow */
        }
        input[type="text"]::placeholder, input[type="password"]::placeholder {
            color: #a0a0a0 !important; /* Lighter placeholder */
        }
        button {
            background-color: #e94560 !important; /* Red button */
            color: white !important;
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5); /* Red glow */
            transition: all 0.3s ease;
        }
        button:hover {
            background-color: #ff0000 !important; /* Brighter red on hover */
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7); /* Intense red glow */
            transform: scale(1.02);
        }
        #login-btn {
            background-color: #00f0ff !important; /* Cyan for login */
            color: #0d0d1a !important; /* Dark text on cyan */
            box-shadow: 0 0 10px rgba(0, 240, 255, 0.5);
        }
        #login-btn:hover {
            background-color: #00e0ee !important;
            box-shadow: 0 0 15px rgba(0, 240, 255, 0.8);
        }
        #logout-btn {
            background-color: #8a2be2 !important; /* Purple for logout */
            box-shadow: 0 0 10px rgba(138, 43, 226, 0.5);
        }
        #logout-btn:hover {
            background-color: #6a0dad !important;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.8);
        }
        #add-client-btn {
            background-color: #e94560 !important; /* Red for add client */
            box-shadow: 0 0 10px rgba(233, 69, 96, 0.5);
        }
        #add-client-btn:hover {
            background-color: #ff0000 !important;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.7);
        }
        .copy-key-btn {
            color: #00f0ff !important; /* Cyan for copy key */
        }
        .copy-key-btn:hover {
            color: #00e0ee !important;
        }
        .bg-green-100 { background-color: rgba(0, 255, 0, 0.1) !important; } /* Subtle green for running */
        .text-green-700 { color: #00ff00 !important; }
        .bg-red-100 { background-color: rgba(255, 0, 0, 0.1) !important; } /* Subtle red for stopped */
        .text-red-700 { color: #ff0000 !important; }
        .bg-yellow-100 { background-color: rgba(255, 255, 0, 0.1) !important; } /* Subtle yellow for maintenance */
        .text-yellow-700 { color: #ffff00 !important; }
        .bg-orange-100 { background-color: rgba(255, 165, 0, 0.1) !important; } /* Subtle orange for degraded */
        .text-orange-700 { color: #ffa500 !important; }

        /* Specific text colors for dashboard/sections */
        .text-blue-600 { color: #00f0ff !important; } /* Cyan for headers */
        .text-purple-700 { color: #8a2be2 !important; } /* Purple for login text */
        .text-gray-800 { color: #e0e0e0 !important; } /* Light gray for general text */
        .text-gray-700 { color: #c0c0c0 !important; }
        .text-gray-600 { color: #a0a0a0 !important; }
        .text-blue-900 { color: #00f0ff !important; } /* Cyan for counts */
        .text-green-900 { color: #00ff00 !important; }
        .text-red-900 { color: #ff0000 !important; }
        .text-orange-900 { color: #ffa500 !important; }
        .text-red-200 { color: #ff6666 !important; } /* Lighter red for error messages */
        .text-yellow-200 { color: #ffff66 !important; } /* Lighter yellow for info messages */
        .text-blue-200 { color: #66ffff !important; }

        /* Backgrounds for content sections */
        .bg-gray-50 {
            background-color: #1a1a2e !important; /* Darker content background */
            border: 1px solid #0f0f23; /* Subtle dark border */
            box-shadow: 0 0 10px rgba(0,0,0,0.5); /* Darker shadow */
        }
        .bg-white {
            background-color: #0f0f23 !important; /* Even darker for client list */
            border: 1px solid #1a1a2e !important;
        }
        .bg-gray-200 {
            background-color: #33334d !important; /* Darker for progress bars */
        }
        .bg-blue-600 {
            background-color: #00f0ff !important; /* Cyan for progress bar fill */
        }
        .bg-gray-50 {
            background-color: #1a1a2e !important;
        }
        .bg-gradient-to-br {
            background-image: linear-gradient(to bottom right, #0f0f23, #1a1a2e) !important; /* Darker gradient for auth */
        }
        .bg-blue-100 { background-color: #1a1a2e !important; border: 1px solid #00f0ff; box-shadow: 0 0 8px rgba(0, 240, 255, 0.2); }
        .bg-green-100 { background-color: #1a1a2e !important; border: 1px solid #00ff00; box-shadow: 0 0 8px rgba(0, 255, 0, 0.2); }
        .bg-red-100 { background-color: #1a1a2e !important; border: 1px solid #ff0000; box-shadow: 0 0 8px rgba(255, 0, 0, 0.2); }
        .bg-orange-100 { background-color: #1a1a2e !important; border: 1px solid #ffa500; box-shadow: 0 0 8px rgba(255, 165, 0, 0.2); }

        /* Specific styles for server cards */
        .p-4.rounded-lg.shadow-sm {
            border: 1px solid #33334d; /* Darker border for cards */
            box-shadow: 0 0 8px rgba(0,0,0,0.3);
        }
        .p-4.rounded-lg.shadow-sm:hover {
            border-color: #8a2be2; /* Purple border on hover */
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.4); /* Purple glow on hover */
        }

        /* Glitch effect for messages */
        @keyframes glitch {
            0% {
                text-shadow: 0.05em 0 0 #00f0ff, -0.05em -0.025em 0 #ff0000, -0.025em 0.05em 0 #00ff00;
            }
            14% {
                text-shadow: -0.05em -0.025em 0 #00f0ff, 0.025em 0.025em 0 #ff0000, -0.05em -0.05em 0 #00ff00;
            }
            15% {
                text-shadow: 0.05em 0.025em 0 #00f0ff, -0.05em 0 0 #ff0000, 0.025em -0.05em 0 #00ff00;
            }
            49% {
                text-shadow: 0.05em 0.025em 0 #00f0ff, -0.05em 0 0 #ff0000, 0.025em -0.05em 0 #00ff00;
            }
            50% {
                text-shadow: -0.05em 0.05em 0 #00f0ff, 0.05em 0 0 #ff0000, -0.05em -0.025em 0 #00ff00;
            }
            99% {
                text-shadow: -0.05em 0.05em 0 #00f0ff, 0.05em 0 0 #ff0000, -0.05em -0.025em 0 #00ff00;
            }
            100% {
                text-shadow: 0.05em 0 0 #00f0ff, -0.05em -0.025em 0 #ff0000, -0.025em 0.05em 0 #00ff00;
            }
        }
        .glitch-text {
            animation: glitch 0.5s infinite alternate;
        }

        /* Toggle switch for maintenance mode */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #8a2be2; /* Purple when checked */
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #8a2be2;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="app" class="bg-white rounded-xl shadow-2xl p-8 w-full max-w-6xl flex flex-col lg:flex-row gap-8">
        <!-- Authentication Section -->
        <div id="auth-section" class="w-full lg:w-1/3 p-6 bg-gradient-to-br from-blue-600 to-purple-700 text-white rounded-lg shadow-lg flex flex-col items-center justify-center text-center">
            <h2 class="text-3xl font-bold mb-6 text-white tracking-wide">Right Cloud: Dominance Protocol</h2>
            <div id="login-form" class="w-full">
                <p class="text-lg mb-4 text-gray-300">Access the core systems.</p>
                <input type="text" id="username" placeholder="Access Key" class="w-full p-3 mb-4 rounded-md bg-white bg-opacity-20 border border-white border-opacity-30 placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition duration-300">
                <input type="password" id="password" placeholder="Authorization Code" class="w-full p-3 mb-6 rounded-md bg-white bg-opacity-20 border border-white border-opacity-30 placeholder-white placeholder-opacity-70 focus:outline-none focus:ring-2 focus:ring-white focus:ring-opacity-50 transition duration-300">
                <button id="login-btn" class="w-full bg-white text-purple-700 font-semibold py-3 rounded-md shadow-md hover:bg-gray-100 hover:text-purple-800 transition duration-300 transform hover:scale-105">Engage Protocol</button>
                <p id="auth-message" class="text-red-200 mt-4 text-sm"></p>
                <div class="mt-4 text-sm">
                    <a href="#" id="forgot-password" class="text-white text-opacity-80 hover:text-white underline">System Override?</a>
                </div>
            </div>
            <div id="user-info" class="hidden w-full text-center">
                <p class="text-xl font-semibold mb-4 text-white">Directive: <span id="display-username"></span></p>
                <button id="logout-btn" class="w-full bg-red-500 text-white font-semibold py-3 rounded-md shadow-md hover:bg-red-600 transition duration-300 transform hover:scale-105">Deactivate Protocol</button>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="w-full lg:w-2/3 flex flex-col gap-8">
            <!-- Dashboard Overview (Visible to both admin and public) -->
            <div id="dashboard-section" class="hidden bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-terminal mr-3 text-blue-600"></i> Command Center Overview
                </h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="bg-blue-100 p-4 rounded-md shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm text-blue-700">Total Nodes</p>
                            <p class="text-2xl font-bold text-blue-900" id="total-servers-count">15</p>
                        </div>
                        <i class="fas fa-network-wired text-blue-500 text-3xl"></i>
                    </div>
                    <div class="bg-green-100 p-4 rounded-md shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm text-green-700">Active Nodes</p>
                            <p class="text-2xl font-bold text-green-900" id="running-servers-count">0</p>
                        </div>
                        <i class="fas fa-play-circle text-green-500 text-3xl"></i>
                    </div>
                    <div class="bg-red-100 p-4 rounded-md shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm text-red-700">Deactivated Nodes</p>
                            <p class="text-2xl font-bold text-red-900" id="stopped-servers-count">0</p>
                        </div>
                        <i class="fas fa-stop-circle text-red-500 text-3xl"></i>
                    </div>
                    <div class="bg-orange-100 p-4 rounded-md shadow-sm flex items-center justify-between">
                        <div>
                            <p class="text-sm text-orange-700">Critical Alerts</p>
                            <p class="text-2xl font-bold text-orange-900" id="alerts-count">0</p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-orange-500 text-3xl"></i>
                    </div>
                </div>
            </div>

            <!-- Server Management Simulation (Admin Only) -->
            <div id="server-management-section" class="hidden bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-server mr-3 text-blue-500"></i> Node Operations
                </h2>
                <div id="server-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Server cards will be injected here by JavaScript -->
                </div>
            </div>

            <!-- Public Capabilities Overview (Public Only) -->
            <div id="public-capabilities-section" class="hidden bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-cloud-upload-alt mr-3 text-purple-500"></i> System Capabilities Overview
                </h2>
                <div class="text-gray-700 space-y-4">
                    <p>Welcome, Observer. This interface provides a high-level overview of the Right Cloud infrastructure's capabilities.</p>
                    <ul class="list-disc list-inside ml-4 space-y-2">
                        <li><i class="fas fa-microchip text-blue-400 mr-2"></i> High-Performance Compute Nodes: Our network comprises 15 advanced processing nodes, capable of handling diverse computational demands.</li>
                        <li><i class="fas fa-database text-green-400 mr-2"></i> Secure Data Storage: Redundant and encrypted data storage solutions ensure maximum data integrity and availability.</li>
                        <li><i class="fas fa-shield-alt text-red-400 mr-2"></i> Robust Security Protocols: Multi-layered security measures, including advanced intrusion detection and real-time threat analysis, protect all system assets.</li>
                        <li><i class="fas fa-globe-americas text-yellow-400 mr-2"></i> Global Network Reach: Optimized network infrastructure for low-latency data transmission across continents.</li>
                        <li><i class="fas fa-cogs text-gray-400 mr-2"></i> Automated Resource Management: Dynamic resource allocation ensures optimal performance and efficiency for all deployed protocols.</li>
                    </ul>
                    <p class="mt-4 text-sm text-gray-600">For detailed operational metrics or client authorization, please use an authorized access key.</p>
                </div>
            </div>


            <!-- Client Management & Key Generation Section (Admin Only) -->
            <div id="client-key-section" class="hidden bg-gray-50 p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-fingerprint mr-3 text-green-500"></i> Client Authorization & Key Generation
                </h2>
                <div class="mb-6" id="client-add-section">
                    <label for="client-name" class="block text-gray-700 text-sm font-semibold mb-2">Client Identifier:</label>
                    <input type="text" id="client-name" placeholder="Enter client identifier" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 transition duration-300">
                    <button id="add-client-btn" class="mt-4 w-full bg-green-600 text-white font-semibold py-3 rounded-md shadow-md hover:bg-green-700 transition duration-300 transform hover:scale-105">
                        Authorize Client & Generate Key
                    </button>
                    <p id="key-gen-message" class="text-red-500 mt-2 text-sm"></p>
                </div>

                <div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Authorized Clients:</h3>
                    <div id="clients-list" class="bg-white p-4 rounded-md border border-gray-200 h-64 overflow-y-auto">
                        <!-- Client list will be injected here by JavaScript -->
                        <p class="text-gray-500 text-center" id="no-clients-message">No clients authorized yet.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Server Details Modal -->
    <div id="server-details-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="modal-server-name"></h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-gray-700">
                <p><strong>Status:</strong> <span id="modal-server-status"></span></p>
                <p><strong>IP Address:</strong> <span id="modal-server-ip"></span></p>
                <p><strong>CPU Load:</strong> <span id="modal-server-cpu"></span></p>
                <p><strong>Memory Usage:</strong> <span id="modal-server-ram"></span></p>
                <p><strong>Disk I/O:</strong> <span id="modal-server-disk-io"></span></p>
                <p><strong>Network Latency:</strong> <span id="modal-server-latency"></span></p>
                <p><strong>Error Rate:</strong> <span id="modal-server-error-rate"></span></p>
                <p><strong>Last Reboot:</strong> <span id="modal-server-uptime"></span></p>
                <p><strong>OS Version:</strong> <span id="modal-server-os"></span></p>
                <p><strong>Kernel:</strong> <span id="modal-server-kernel"></span></p>
                <p><strong>Security Patch:</strong> <span id="modal-server-security-patch"></span></p>
                <p><strong>Connected Users:</strong> <span id="modal-connected-users"></span></p> <!-- New -->
                <p><strong>Active Processes:</strong> <span id="modal-active-processes"></span></p> <!-- New -->
                <p><strong>Network Throughput:</strong> <span id="modal-network-throughput"></span></p> <!-- New -->
            </div>
            <div class="mt-6">
                <h4 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-chart-line mr-2 text-blue-600"></i>Traffic Visualization:</h4>
                <canvas id="traffic-chart" class="bg-gray-200 rounded-md p-2" width="600" height="150"></canvas>
            </div>
            <div class="mt-6">
                <h4 class="text-xl font-semibold text-gray-800 mb-3 flex items-center"><i class="fas fa-file-alt mr-2 text-yellow-600"></i>Recent Logs:</h4>
                <div id="server-logs" class="bg-gray-200 text-gray-700 p-4 rounded-md h-40 overflow-y-auto text-sm">
                    <!-- Logs will be injected here -->
                </div>
            </div>
            <div id="maintenance-toggle-row" class="mt-6 flex items-center justify-between">
                <label for="maintenance-mode" class="text-lg font-semibold text-gray-800">Initiate Maintenance Protocol:</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="maintenance-mode">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="mt-6 flex flex-wrap justify-end gap-4" id="server-actions-container">
                <button id="modal-restart-btn" class="bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-300">Initiate Reboot</button>
                <button id="modal-stop-btn" class="bg-red-500 text-white py-2 px-4 rounded-md hover:bg-red-600 transition duration-300">Terminate Node</button>
                <button id="modal-deploy-btn" class="bg-purple-600 text-white py-2 px-4 rounded-md hover:bg-purple-700 transition duration-300">Deploy Update</button>
                <button id="modal-rollback-btn" class="bg-orange-600 text-white py-2 px-4 rounded-md hover:bg-orange-700 transition duration-300">Rollback Version</button>
                <button id="modal-isolate-btn" class="bg-gray-700 text-white py-2 px-4 rounded-md hover:bg-gray-800 transition duration-300">Isolate Node</button> <!-- New -->
                <button id="modal-purge-logs-btn" class="bg-yellow-700 text-white py-2 px-4 rounded-md hover:bg-yellow-800 transition duration-300">Purge Logs</button> <!-- New -->
                <button id="modal-scale-resources-btn" class="bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition duration-300">Scale Resources</button> <!-- New -->
                <button id="modal-force-sync-btn" class="bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300">Force Sync</button> <!-- New -->
            </div>
            <p id="modal-action-message" class="text-sm mt-4 text-center text-gray-600"></p>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const ADMIN_USERNAME = 'right';
        const ADMIN_PASSWORD = '88525';
        const PUBLIC_USERNAME = 'public';
        const PUBLIC_PASSWORD = 'right';

        // Initial list of serial keys provided by the user
        const initialSerialKeys = [
            'RSAI1-8ZK4Y-JG2ML-T9VQD-C3XNB', 'RSAI1-MZ7QD-4TPFX-K8E2L-YWCMR',
            'RSAI1-KN9VG-ECZ42-MY7QF-TL8DW', 'RSAI1-BVXW4-QTMC3-DRK9Y-JG72L',
            'RSAI1-PT9KD-XFML7-BQ82C-GYNVW', 'RSAI1-HF7ZP-M2CVQ-WXDK9-TRBLY',
            'RSAI1-YCML9-RGFTK-3X8WQ-V72BE', 'RSAI1-LX2RD-FP7KQ-MYNW3-VBZC4',
            'RSAI1-WKTY8-CVZ4L-N9MBQ-ER7XJ', 'RSAI1-ZML7Q-YT9WB-XFDCE-GQV28',
            'RSAI1-MCYWQ-7RDLK-F2X98-TVGZ4', 'RSAI1-PNT8V-ZKCY3-WL9FQ-GMDXR',
            'RSAI1-KFXC7-TYBVL-W93QD-EMN4Z', 'RSAI1-VGKW4-ZM9LQ-XFTYR-C8PNE',
            'RSAI1-WRPZ7-MXYNC-DQ94V-TBKFL', 'RSAI1-GBXQ8-WFZTP-L9KYC-MV7DR',
            'RSAI1-XD72K-VTLCM-YWBRQ-GPZ98', 'RSAI1-KWZ3N-LVYTP-98BMF-XCDRQ',
            'RSAI1-ZL7XQ-NMTCV-W8BGR-YD29K', 'RSAI1-YTCKV-RP8LM-Q3ZBD-NWF74',
            'RSAI1-QWMB9-DC4TZ-YKXPL-VF7GR', 'RSAI1-ZDRTY-8KVWN-LQMB3-CXP7F',
            'RSAI1-KRZML-VF8WD-T9CBX-YMQLP', 'RSAI1-BGVCP-XMZQ4-LT9WR-FYKND',
            'RSAI1-9WDVC-BRQZL-MTKY8-XP7GF', 'RSAI1-MLYK8-GZWRQ-BXDPT-VN43C',
            'RSAI1-YKPZD-TRWBX-VQM7L-CFGN8', 'RSAI1-WTZVC-XRM9B-PKYFL-GDQ37',
            'RSAI1-CMBYW-TQF9X-KLDZR-V7PGN', 'RSAI1-XRYMF-ZVDPK-LW3NQ-GBT98',
            'RSAI1-PKYFL-TMC8Q-W9DZR-XNBGV', 'RSAI1-VZRW8-KQYTD-MNPLC-XGF93',
            'RSAI1-W9ZDR-MKXTY-VBQFL-NCPG7', 'RSAI1-TYMZQ-F8XVD-WRCLP-KNGB9',
            'RSAI1-BPXWM-K9ZDR-TLYCQ-VGFN8', 'RSAI1-GYBDL-VRTPM-QCWZX-KN8F3',
            'RSAI1-ZWVPK-NTQ9X-MCYBR-FGLD8', 'RSAI1-MTLYQ-VBXZC-W9DRK-PNFG3',
            'RSAI1-YDZVM-KQCXP-TN8LB-WGFR4', 'RSAI1-LMKYQ-TFZD9-VBWXP-RGCN8',
            'RSAI1-XTPWQ-NCYLB-FZVRK-MD839', 'RSAI1-Q9MZC-XTWLB-KRFGY-PVDN8',
            'RSAI1-WDLTY-RVBNM-CXQPZ-GKF38', 'RSAI1-ZTVQX-MNPLB-KY9DR-CFWG8',
            'RSAI1-MYLQK-ZCVRW-P8DTX-BFGN3', 'RSAI1-VCMBP-RXWTQ-D9LGY-ZNF84',
            'RSAI1-LTMBW-QCVZD-RKXNP-YGF83', 'RSAI1-XCYRQ-VTGZK-W9MBF-LPDN7',
            'RSAI1-YWTPM-BLZCR-XFNDQ-VK389', 'RSAI1-KQZMC-T8WLD-YRPXN-BFVG3'
        ];

        // --- DOM Elements ---
        const authSection = document.getElementById('auth-section');
        const loginForm = document.getElementById('login-form');
        const userInfo = document.getElementById('user-info');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authMessage = document.getElementById('auth-message');
        const displayUsername = document.getElementById('display-username');
        const forgotPasswordLink = document.getElementById('forgot-password');

        const dashboardSection = document.getElementById('dashboard-section');
        const serverManagementSection = document.getElementById('server-management-section');
        const publicCapabilitiesSection = document.getElementById('public-capabilities-section');
        const serverGrid = document.getElementById('server-grid');
        const clientKeySection = document.getElementById('client-key-section');
        const clientNameInput = document.getElementById('client-name');
        const addClientBtn = document.getElementById('add-client-btn');
        const clientsList = document.getElementById('clients-list');
        const keyGenMessage = document.getElementById('key-gen-message');
        const noClientsMessage = document.getElementById('no-clients-message');
        const clientAddSection = document.getElementById('client-add-section');

        const totalServersCount = document.getElementById('total-servers-count');
        const runningServersCount = document.getElementById('running-servers-count');
        const stoppedServersCount = document.getElementById('stopped-servers-count');
        const alertsCount = document.getElementById('alerts-count');

        // Server Details Modal Elements
        const serverDetailsModal = document.getElementById('server-details-modal');
        const closeModalBtn = serverDetailsModal ? serverDetailsModal.querySelector('.close-button') : null;
        const modalServerName = document.getElementById('modal-server-name');
        const modalServerStatus = document.getElementById('modal-server-status');
        const modalServerIp = document.getElementById('modal-server-ip');
        const modalServerCpu = document.getElementById('modal-server-cpu');
        const modalServerRam = document.getElementById('modal-server-ram');
        const modalServerDiskIO = document.getElementById('modal-server-disk-io');
        const modalServerLatency = document.getElementById('modal-server-latency');
        const modalServerErrorRate = document.getElementById('modal-server-error-rate');
        const modalServerUptime = document.getElementById('modal-server-uptime');
        const modalServerOS = document.getElementById('modal-server-os');
        const modalServerKernel = document.getElementById('modal-server-kernel');
        const modalServerSecurityPatch = document.getElementById('modal-server-security-patch');
        const modalConnectedUsers = document.getElementById('modal-connected-users'); // New
        const modalActiveProcesses = document.getElementById('modal-active-processes'); // New
        const modalNetworkThroughput = document.getElementById('modal-network-throughput'); // New
        const serverLogsDiv = document.getElementById('server-logs');
        const trafficChartCanvas = document.getElementById('traffic-chart');
        const maintenanceModeToggle = document.getElementById('maintenance-mode');
        const maintenanceToggleRow = document.getElementById('maintenance-toggle-row');
        const serverActionsContainer = document.getElementById('server-actions-container');

        const modalRestartBtn = document.getElementById('modal-restart-btn');
        const modalStopBtn = document.getElementById('modal-stop-btn');
        const modalDeployBtn = document.getElementById('modal-deploy-btn');
        const modalRollbackBtn = document.getElementById('modal-rollback-btn');
        const modalIsolateBtn = document.getElementById('modal-isolate-btn'); // New
        const modalPurgeLogsBtn = document.getElementById('modal-purge-logs-btn'); // New
        const modalScaleResourcesBtn = document.getElementById('modal-scale-resources-btn'); // New
        const modalForceSyncBtn = document.getElementById('modal-force-sync-btn'); // New
        const modalActionMessage = document.getElementById('modal-action-message');

        // --- Global State Variables ---
        let isAuthenticated = false;
        let currentUserRole = 'guest'; // 'guest', 'public', 'admin'
        let clients = [];
        let availableKeys = [];
        let servers = []; // Array to hold server data

        // --- Local Storage Keys ---
        const LS_AUTH_STATUS = 'rightCloudAuthStatus';
        const LS_CURRENT_USER_ROLE = 'rightCloudUserRole';
        const LS_CLIENTS = 'rightCloudClients';
        const LS_AVAILABLE_KEYS = 'rightCloudAvailableKeys';
        const LS_SERVERS = 'rightCloudServers';

        // --- Helper Functions ---

        /**
         * Generates a random IP address.
         * @returns {string} A random IPv4 address.
         */
        function generateRandomIp() {
            return Array(4).fill(0).map(() => Math.floor(Math.random() * 256)).join('.');
        }

        /**
         * Generates a random uptime string.
         * @returns {string} A random uptime string (e.g., "5d 12h 30m").
         */
        function generateRandomUptime() {
            const days = Math.floor(Math.random() * 30) + 1; // 1 to 30 days
            const hours = Math.floor(Math.random() * 24);
            const minutes = Math.floor(Math.random() * 60);
            return `${days}d ${hours}h ${minutes}m`;
        }

        /**
         * Generates a random percentage string.
         * @returns {string} A random percentage (e.g., "75%").
         */
        function generateRandomPercentage() {
            return `${Math.floor(Math.random() * 90) + 10}%`; // 10% to 99%
        }

        /**
         * Generates a random disk I/O string.
         * @returns {string} A random disk I/O (e.g., "120MB/s").
         */
        function generateRandomDiskIO() {
            return `${Math.floor(Math.random() * 500) + 50}MB/s`;
        }

        /**
         * Generates a random network latency string.
         * @returns {string} A random latency (e.g., "25ms").
         */
        function generateRandomLatency() {
            return `${Math.floor(Math.random() * 100) + 5}ms`;
        }

        /**
         * Generates a random error rate string.
         * @returns {string} A random error rate (e.g., "0.05%").
         */
        function generateRandomErrorRate() {
            return `${(Math.random() * 0.5).toFixed(2)}%`; // 0.00% to 0.50%
        }

        /**
         * Generates a random OS version.
         * @returns {string} A random OS version.
         */
        function generateRandomOS() {
            const os = ['Linux (Ubuntu 22.04)', 'Linux (CentOS 8)', 'Windows Server 2022', 'FreeBSD 13.1'];
            return os[Math.floor(Math.random() * os.length)];
        }

        /**
         * Generates a random kernel version.
         * @returns {string} A random kernel version.
         */
        function generateRandomKernel() {
            const kernels = ['5.15.0-91-generic', '4.18.0-425.10.1.el8', '10.0.20348.1', '13.1-RELEASE-p6'];
            return kernels[Math.floor(Math.random() * kernels.length)];
        }

        /**
         * Generates a random security patch level.
         * @returns {string} A random security patch level.
         */
        function generateRandomSecurityPatch() {
            const patches = ['Latest', '2024-06-B', '2024-05-A', 'Critical Update Pending'];
            return patches[Math.floor(Math.random() * patches.length)];
        }

        /**
         * Generates a random number of connected users.
         * @returns {number} A random number of users.
         */
        function generateRandomConnectedUsers() {
            return Math.floor(Math.random() * 50) + 5; // 5 to 54 users
        }

        /**
         * Generates a random number of active processes.
         * @returns {number} A random number of processes.
         */
        function generateRandomActiveProcesses() {
            return Math.floor(Math.random() * 200) + 50; // 50 to 249 processes
        }

        /**
         * Generates a random network throughput.
         * @returns {string} A random throughput (e.g., "1.2 Gbps").
         */
        function generateRandomNetworkThroughput() {
            const value = (Math.random() * 5 + 0.5).toFixed(1); // 0.5 to 5.5 Gbps
            return `${value} Gbps`;
        }


        /**
         * Generates simulated server logs.
         * @returns {string[]} An array of simulated log entries.
         */
        function generateSimulatedLogs() {
            const logTypes = ['INFO', 'WARNING', 'ERROR', 'DEBUG'];
            const messages = [
                'System heartbeat detected.',
                'Disk usage at 75%. Threshold alert.',
                'Network anomaly detected. Investigating.',
                'Authentication successful for user root.',
                'Failed login attempt from unauthorized IP.',
                'Resource allocation adjusted.',
                'Database connection re-established.',
                'Critical process terminated unexpectedly.',
                'Scheduled backup initiated.',
                'Memory leak detected in process PID 1234.'
            ];
            const logs = [];
            for (let i = 0; i < 10; i++) {
                const type = logTypes[Math.floor(Math.random() * logTypes.length)];
                const msg = messages[Math.floor(Math.random() * messages.length)];
                logs.push(`[${new Date().toLocaleTimeString()}] [${type}] ${msg}`);
            }
            return logs;
        }

        /**
         * Generates simulated traffic data for a chart.
         * @returns {number[]} An array of traffic values.
         */
        function generateSimulatedTrafficData() {
            const data = [];
            for (let i = 0; i < 30; i++) { // 30 data points
                data.push(Math.floor(Math.random() * 100) + 20); // Values between 20 and 120
            }
            return data;
        }

        /**
         * Draws a simple line chart on a canvas.
         * @param {HTMLCanvasElement} canvas The canvas element.
         * @param {number[]} data The data points to plot.
         */
        function drawLineChart(canvas, data) {
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const padding = 20;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;
            const maxVal = Math.max(...data);
            const minVal = Math.min(...data);
            const range = maxVal - minVal;

            ctx.strokeStyle = '#00f0ff'; // Cyan line
            ctx.lineWidth = 2;

            ctx.beginPath();
            ctx.moveTo(padding, padding + height - ((data[0] - minVal) / range) * height);

            for (let i = 1; i < data.length; i++) {
                const x = padding + (i / (data.length - 1)) * width;
                const y = padding + height - ((data[i] - minVal) / range) * height;
                ctx.lineTo(x, y);
            }
            ctx.stroke();

            // Draw points
            ctx.fillStyle = '#ff0000'; // Red points
            data.forEach((val, i) => {
                const x = padding + (i / (data.length - 1)) * width;
                const y = padding + height - ((val - minVal) / range) * height;
                ctx.beginPath();
                ctx.arc(x, y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
        }


        // --- Core Functions ---

        /**
         * Loads the application state from Local Storage.
         * Initializes clients, availableKeys, and authentication status.
         */
        function loadStateFromLocalStorage() {
            try {
                isAuthenticated = localStorage.getItem(LS_AUTH_STATUS) === 'true';
                currentUserRole = localStorage.getItem(LS_CURRENT_USER_ROLE) || 'guest';

                const storedClients = localStorage.getItem(LS_CLIENTS);
                clients = storedClients ? JSON.parse(storedClients) : [];

                const storedAvailableKeys = localStorage.getItem(LS_AVAILABLE_KEYS);
                availableKeys = storedAvailableKeys ? JSON.parse(storedAvailableKeys) : [...initialSerialKeys];

                const storedServers = localStorage.getItem(LS_SERVERS);
                servers = storedServers ? JSON.parse(storedServers) : [];

                // Initialize servers if they don't exist or if the count is off or properties are missing
                if (servers.length === 0 || servers.length !== 15 || !servers[0].osVersion || !servers[0].connectedUsers) { // Check for new property
                    servers = [];
                    const serverStatuses = ['Running', 'Stopped', 'Maintenance', 'Degraded', 'Isolated']; // Added Isolated
                    for (let i = 1; i <= 15; i++) {
                        servers.push({
                            id: `node-${String(i).padStart(2, '0')}`,
                            name: `Node-${String(i).padStart(2, '0')}`,
                            status: serverStatuses[Math.floor(Math.random() * serverStatuses.length)],
                            ip: generateRandomIp(),
                            cpu: generateRandomPercentage(),
                            ram: generateRandomPercentage(),
                            diskIO: generateRandomDiskIO(),
                            latency: generateRandomLatency(),
                            errorRate: generateRandomErrorRate(),
                            uptime: generateRandomUptime(),
                            osVersion: generateRandomOS(),
                            kernelVersion: generateRandomKernel(),
                            securityPatch: generateRandomSecurityPatch(),
                            connectedUsers: generateRandomConnectedUsers(), // New
                            activeProcesses: generateRandomActiveProcesses(), // New
                            networkThroughput: generateRandomNetworkThroughput(), // New
                            logs: generateSimulatedLogs(),
                            trafficData: generateSimulatedTrafficData(),
                            isMaintenance: false
                        });
                    }
                } else {
                    // Ensure existing servers have new properties if they were loaded from an older state
                    servers.forEach(server => {
                        if (!server.osVersion) server.osVersion = generateRandomOS();
                        if (!server.kernelVersion) server.kernelVersion = generateRandomKernel();
                        if (!server.securityPatch) server.securityPatch = generateRandomSecurityPatch();
                        if (!server.connectedUsers) server.connectedUsers = generateRandomConnectedUsers(); // New
                        if (!server.activeProcesses) server.activeProcesses = generateRandomActiveProcesses(); // New
                        if (!server.networkThroughput) server.networkThroughput = generateRandomNetworkThroughput(); // New
                        if (!server.logs || server.logs.length === 0) server.logs = generateSimulatedLogs();
                        if (!server.trafficData || server.trafficData.length === 0) server.trafficData = generateSimulatedTrafficData();
                        if (typeof server.isMaintenance === 'undefined') server.isMaintenance = false;
                    });
                }


                // Ensure availableKeys only contains keys not already assigned to clients
                const usedKeys = new Set(clients.map(c => c.key));
                availableKeys = availableKeys.filter(key => !usedKeys.has(key));
                // Also add any new keys from initialSerialKeys that haven't been used yet
                const currentKeysInAvailable = new Set(availableKeys);
                initialSerialKeys.forEach(key => {
                    if (!usedKeys.has(key) && !currentKeysInAvailable.has(key)) {
                        availableKeys.push(key);
                    }
                });

            } catch (error) {
                console.error("Error loading state from local storage:", error);
                // Fallback to default state if local storage is corrupted
                isAuthenticated = false;
                currentUserRole = 'guest';
                clients = [];
                availableKeys = [...initialSerialKeys];
                servers = []; // Will be re-initialized by the check above
            }
        }

        /**
         * Saves the current application state to Local Storage.
         */
        function saveStateToLocalStorage() {
            try {
                localStorage.setItem(LS_AUTH_STATUS, isAuthenticated);
                localStorage.setItem(LS_CURRENT_USER_ROLE, currentUserRole);
                localStorage.setItem(LS_CLIENTS, JSON.stringify(clients));
                localStorage.setItem(LS_AVAILABLE_KEYS, JSON.stringify(availableKeys));
                localStorage.setItem(LS_SERVERS, JSON.stringify(servers));
            } catch (error) {
                console.error("Error saving state to local storage:", error);
            }
        }

        /**
         * Renders the simulated server cards.
         */
        function renderServers() {
            if (!serverGrid) {
                console.error("Error: serverGrid element not found.");
                return;
            }
            serverGrid.innerHTML = ''; // Clear previous servers
            const statusColors = {
                'Running': 'bg-green-100 text-green-700',
                'Stopped': 'bg-red-100 text-red-700',
                'Maintenance': 'bg-yellow-100 text-yellow-700',
                'Degraded': 'bg-orange-100 text-orange-700',
                'Isolated': 'bg-gray-700 text-gray-300' // New color for isolated
            };
            const statusIcons = {
                'Running': '<i class="fas fa-check-circle"></i>',
                'Stopped': '<i class="fas fa-times-circle"></i>',
                'Maintenance': '<i class="fas fa-tools"></i>',
                'Degraded': '<i class="fas fa-exclamation-triangle"></i>',
                'Isolated': '<i class="fas fa-unlink"></i>' // New icon for isolated
            };

            servers.forEach(server => {
                const serverCard = document.createElement('div');
                serverCard.className = `p-4 rounded-lg shadow-sm flex flex-col ${statusColors[server.status]}`;

                // Only make cards clickable for admin
                if (currentUserRole === 'admin') {
                    serverCard.classList.add('cursor-pointer', 'hover:shadow-md', 'transition', 'duration-200');
                    serverCard.dataset.serverId = server.id; // Store ID for click handling
                }

                serverCard.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-lg">${server.name}</h3>
                        <div class="text-xl">${statusIcons[server.status]}</div>
                    </div>
                    <p class="text-sm">Status: ${server.status}</p>
                    <p class="text-xs text-gray-600">IP: ${server.ip}</p>
                    <div class="w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${server.cpu}"></div>
                    </div>
                    <p class="text-xs text-gray-600 mt-1">CPU: ${server.cpu}</p>
                `;
                serverGrid.appendChild(serverCard);
            });

            // Add event listeners for server cards ONLY IF ADMIN
            if (currentUserRole === 'admin') {
                document.querySelectorAll('#server-grid .p-4.rounded-lg.shadow-sm').forEach(card => {
                    card.addEventListener('click', (event) => {
                        const serverId = event.currentTarget.dataset.serverId;
                        showServerDetails(serverId);
                    });
                });
            }
        }

        /**
         * Updates the dashboard counts based on current server statuses.
         */
        function updateDashboardCounts() {
            let runningCount = 0;
            let stoppedCount = 0;
            let maintenanceCount = 0;
            let degradedCount = 0;
            let isolatedCount = 0; // New

            servers.forEach(server => {
                if (server.status === 'Running') runningCount++;
                else if (server.status === 'Stopped') stoppedCount++;
                else if (server.status === 'Maintenance') maintenanceCount++;
                else if (server.status === 'Degraded') degradedCount++;
                else if (server.status === 'Isolated') isolatedCount++; // New
            });

            if (totalServersCount) totalServersCount.textContent = servers.length;
            if (runningServersCount) runningServersCount.textContent = runningCount;
            if (stoppedServersCount) stoppedServersCount.textContent = stoppedCount;
            // For alerts, we can combine Maintenance, Degraded, and Isolated
            if (alertsCount) alertsCount.textContent = maintenanceCount + degradedCount + isolatedCount;
        }

        /**
         * Displays the server details modal for a given server ID.
         * @param {string} serverId The ID of the server to display.
         */
        function showServerDetails(serverId) {
            // Prevent public users from opening the modal
            if (currentUserRole !== 'admin') {
                console.warn("Attempted to access server details as non-admin user.");
                return;
            }

            const server = servers.find(s => s.id === serverId);
            if (!server) return;

            // Ensure all modal elements exist before attempting to set their properties
            if (modalServerName) modalServerName.textContent = server.name;
            if (modalServerStatus) modalServerStatus.textContent = server.status;
            if (modalServerIp) modalServerIp.textContent = server.ip;
            if (modalServerCpu) modalServerCpu.textContent = server.cpu;
            if (modalServerRam) modalServerRam.textContent = server.ram;
            if (modalServerDiskIO) modalServerDiskIO.textContent = server.diskIO;
            if (modalServerLatency) modalServerLatency.textContent = server.latency;
            if (modalServerErrorRate) modalServerErrorRate.textContent = server.errorRate;
            if (modalServerUptime) modalServerUptime.textContent = server.uptime;
            if (modalServerOS) modalServerOS.textContent = server.osVersion;
            if (modalServerKernel) modalServerKernel.textContent = server.kernelVersion;
            if (modalServerSecurityPatch) modalServerSecurityPatch.textContent = server.securityPatch;
            if (modalConnectedUsers) modalConnectedUsers.textContent = server.connectedUsers; // New
            if (modalActiveProcesses) modalActiveProcesses.textContent = server.activeProcesses; // New
            if (modalNetworkThroughput) modalNetworkThroughput.textContent = server.networkThroughput; // New
            if (modalActionMessage) modalActionMessage.textContent = ''; // Clear previous messages

            // Populate logs
            if (serverLogsDiv) {
                serverLogsDiv.innerHTML = server.logs.map(log => `<p>${log}</p>`).join('');
                serverLogsDiv.scrollTop = serverLogsDiv.scrollHeight; // Scroll to bottom
            }

            // Draw traffic chart
            if (trafficChartCanvas) {
                drawLineChart(trafficChartCanvas, server.trafficData);
            }

            // Set maintenance mode toggle state
            if (maintenanceModeToggle) {
                maintenanceModeToggle.checked = server.isMaintenance;
            }

            // Update button states based on server status AND user role (already checked isAdmin above)
            // Note: Isolated status implies most actions are disabled
            const isRunning = server.status === 'Running';
            const isStopped = server.status === 'Stopped';
            const isMaintenance = server.status === 'Maintenance';
            const isIsolated = server.status === 'Isolated';

            if (modalRestartBtn) modalRestartBtn.disabled = isMaintenance || isIsolated;
            if (modalStopBtn) modalStopBtn.disabled = isStopped || isMaintenance || isIsolated;
            if (modalDeployBtn) modalDeployBtn.disabled = !isRunning;
            if (modalRollbackBtn) modalRollbackBtn.disabled = !isRunning;
            if (modalIsolateBtn) modalIsolateBtn.disabled = isIsolated; // Cannot isolate an already isolated node
            if (modalPurgeLogsBtn) modalPurgeLogsBtn.disabled = isStopped || isIsolated; // Can't purge logs if node is stopped or isolated
            if (modalScaleResourcesBtn) modalScaleResourcesBtn.disabled = !isRunning;
            if (modalForceSyncBtn) modalForceSyncBtn.disabled = !isRunning;


            if (maintenanceModeToggle) maintenanceModeToggle.disabled = false; // Admin can always toggle

            // Ensure actions container and toggle row are visible for admin
            if (serverActionsContainer) serverActionsContainer.classList.remove('hidden');
            if (maintenanceToggleRow) maintenanceToggleRow.classList.remove('hidden');


            // Remove previous event listeners to prevent duplicates and get new references
            // Only clone if the element exists
            if (modalRestartBtn) modalRestartBtn.replaceWith(modalRestartBtn.cloneNode(true));
            if (modalStopBtn) modalStopBtn.replaceWith(modalStopBtn.cloneNode(true));
            if (modalDeployBtn) modalDeployBtn.replaceWith(modalDeployBtn.cloneNode(true));
            if (modalRollbackBtn) modalRollbackBtn.replaceWith(modalRollbackBtn.cloneNode(true));
            if (modalIsolateBtn) modalIsolateBtn.replaceWith(modalIsolateBtn.cloneNode(true)); // New
            if (modalPurgeLogsBtn) modalPurgeLogsBtn.replaceWith(modalPurgeLogsBtn.cloneNode(true)); // New
            if (modalScaleResourcesBtn) modalScaleResourcesBtn.replaceWith(modalScaleResourcesBtn.cloneNode(true)); // New
            if (modalForceSyncBtn) modalForceSyncBtn.replaceWith(modalForceSyncBtn.cloneNode(true)); // New
            if (maintenanceModeToggle) maintenanceModeToggle.replaceWith(maintenanceModeToggle.cloneNode(true)); // Also clone the toggle

            const newModalRestartBtn = document.getElementById('modal-restart-btn');
            const newModalStopBtn = document.getElementById('modal-stop-btn');
            const newModalDeployBtn = document.getElementById('modal-deploy-btn');
            const newModalRollbackBtn = document.getElementById('modal-rollback-btn');
            const newModalIsolateBtn = document.getElementById('modal-isolate-btn'); // New
            const newModalPurgeLogsBtn = document.getElementById('modal-purge-logs-btn'); // New
            const newModalScaleResourcesBtn = document.getElementById('modal-scale-resources-btn'); // New
            const newModalForceSyncBtn = document.getElementById('modal-force-sync-btn'); // New
            const newMaintenanceModeToggle = document.getElementById('maintenance-mode');

            // Re-apply disabled/checked states to the new elements
            if (newModalRestartBtn) newModalRestartBtn.disabled = isMaintenance || isIsolated;
            if (newModalStopBtn) newModalStopBtn.disabled = isStopped || isMaintenance || isIsolated;
            if (newModalDeployBtn) newModalDeployBtn.disabled = !isRunning;
            if (newModalRollbackBtn) newModalRollbackBtn.disabled = !isRunning;
            if (newModalIsolateBtn) newModalIsolateBtn.disabled = isIsolated;
            if (newModalPurgeLogsBtn) newModalPurgeLogsBtn.disabled = isStopped || isIsolated;
            if (newModalScaleResourcesBtn) newModalScaleResourcesBtn.disabled = !isRunning;
            if (newModalForceSyncBtn) newModalForceSyncBtn.disabled = !isRunning;

            if (newMaintenanceModeToggle) {
                newMaintenanceModeToggle.disabled = false; // Admin can always toggle
                newMaintenanceModeToggle.checked = server.isMaintenance;
            }

            // Attach event listeners to the new elements
            if (newModalRestartBtn) {
                newModalRestartBtn.addEventListener('click', () => {
                    if (server.status !== 'Maintenance' && server.status !== 'Isolated') { // Cannot restart if isolated
                        server.status = 'Maintenance'; // Simulate reboot process
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Initiating reboot sequence...`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                            server.status = 'Running';
                            server.uptime = generateRandomUptime(); // Reset uptime
                            server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Node rebooted successfully.`);
                            server.logs = server.logs.slice(0, 10); // Keep last 10 logs
                            if (modalActionMessage) {
                                modalActionMessage.textContent = `${server.name}: Reboot complete. Node operational.`;
                                modalActionMessage.classList.remove('glitch-text');
                            }
                            saveStateToLocalStorage();
                            renderServers();
                            updateDashboardCounts();
                            showServerDetails(serverId); // Re-render modal with updated status
                        }, 3000); // Longer simulation time
                    }
                });
            }


            if (newModalStopBtn) {
                newModalStopBtn.addEventListener('click', () => {
                    if (server.status !== 'Stopped' && server.status !== 'Maintenance' && server.status !== 'Isolated') { // Cannot stop if isolated
                        server.status = 'Stopped'; // Simulate stop
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Terminating node connection...`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                            server.logs.unshift(`[${new Date().toLocaleTimeString()}] [WARNING] Node terminated by operator.`);
                            server.logs = server.logs.slice(0, 10);
                            if (modalActionMessage) {
                                modalActionMessage.textContent = `${server.name}: Node successfully terminated.`;
                                modalActionMessage.classList.remove('glitch-text');
                            }
                            saveStateToLocalStorage();
                            renderServers();
                            updateDashboardCounts();
                            showServerDetails(serverId); // Re-render modal with updated status
                        }, 2000);
                    }
                });
            }


            if (newModalDeployBtn) {
                newModalDeployBtn.addEventListener('click', () => {
                    if (server.status === 'Running') {
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Deploying critical update...`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        setTimeout(() => {
                            server.errorRate = generateRandomErrorRate(); // Simulate potential change after update
                            server.securityPatch = 'Latest'; // Simulate patch application
                            server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Critical update deployed.`);
                            server.logs = server.logs.slice(0, 10);
                            if (modalActionMessage) {
                                modalActionMessage.textContent = `${server.name}: Update deployed. System integrity check initiated.`;
                                modalActionMessage.classList.remove('glitch-text');
                            }
                            saveStateToLocalStorage();
                            renderServers();
                            updateDashboardCounts();
                            showServerDetails(serverId);
                        }, 2500);
                    }
                });
            }


            if (newModalRollbackBtn) {
                newModalRollbackBtn.addEventListener('click', () => {
                    if (server.status === 'Running') {
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Initiating system rollback...`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        setTimeout(() => {
                            server.errorRate = generateRandomErrorRate(); // Simulate change
                            server.securityPatch = '2024-05-A'; // Simulate rollback to older patch
                            server.logs.unshift(`[${new Date().toLocaleTimeString()}] [WARNING] System rollback initiated.`);
                            server.logs = server.logs.slice(0, 10);
                            if (modalActionMessage) {
                                modalActionMessage.textContent = `${server.name}: Rollback complete. Previous version restored.`;
                                modalActionMessage.classList.remove('glitch-text');
                            }
                            saveStateToLocalStorage();
                            renderServers();
                            updateDashboardCounts();
                            showServerDetails(serverId);
                        }, 2500);
                    }
                });
            }

            if (newModalIsolateBtn) {
                newModalIsolateBtn.addEventListener('click', () => {
                    if (server.status !== 'Isolated') {
                        server.status = 'Isolated';
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Node isolated from network. All external connections severed.`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        server.logs.unshift(`[${new Date().toLocaleTimeString()}] [CRITICAL] Node isolated by operator.`);
                        server.logs = server.logs.slice(0, 10);
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                             if (modalActionMessage) modalActionMessage.classList.remove('glitch-text');
                             showServerDetails(serverId); // Re-render modal to update status and button states
                        }, 1500);
                    }
                });
            }

            if (newModalPurgeLogsBtn) {
                newModalPurgeLogsBtn.addEventListener('click', () => {
                    if (server.status !== 'Stopped' && server.status !== 'Isolated') {
                        server.logs = [`[${new Date().toLocaleTimeString()}] [INFO] Logs purged by operator.`];
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Log archives purged. Data integrity maintained.`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                            if (modalActionMessage) modalActionMessage.classList.remove('glitch-text');
                            showServerDetails(serverId);
                        }, 1500);
                    }
                });
            }

            if (newModalScaleResourcesBtn) {
                newModalScaleResourcesBtn.addEventListener('click', () => {
                    if (server.status === 'Running') {
                        const currentCpu = parseInt(server.cpu.replace('%', ''));
                        const currentRam = parseInt(server.ram.replace('%', ''));
                        const newCpu = Math.min(100, currentCpu + 10); // Scale up by 10%
                        const newRam = Math.min(100, currentRam + 5); // Scale up by 5%
                        server.cpu = `${newCpu}%`;
                        server.ram = `${newRam}%`;
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Resource allocation increased. CPU: ${newCpu}%, RAM: ${newRam}%.`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Resources scaled up.`);
                        server.logs = server.logs.slice(0, 10);
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                            if (modalActionMessage) modalActionMessage.classList.remove('glitch-text');
                            showServerDetails(serverId);
                        }, 1500);
                    }
                });
            }

            if (newModalForceSyncBtn) {
                newModalForceSyncBtn.addEventListener('click', () => {
                    if (server.status === 'Running') {
                        if (modalActionMessage) {
                            modalActionMessage.textContent = `${server.name}: Initiating forced data synchronization...`;
                            modalActionMessage.classList.add('glitch-text');
                        }
                        server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Forced data synchronization initiated.`);
                        server.logs = server.logs.slice(0, 10);
                        saveStateToLocalStorage();
                        renderServers();
                        updateDashboardCounts();
                        setTimeout(() => {
                            server.errorRate = generateRandomErrorRate(); // Simulate some data change
                            if (modalActionMessage) {
                                modalActionMessage.textContent = `${server.name}: Data synchronization complete. Integrity verified.`;
                                modalActionMessage.classList.remove('glitch-text');
                            }
                            showServerDetails(serverId);
                        }, 2000);
                    }
                });
            }


            if (newMaintenanceModeToggle) {
                newMaintenanceModeToggle.addEventListener('change', () => {
                    server.isMaintenance = newMaintenanceModeToggle.checked;
                    if (server.isMaintenance) {
                        server.status = 'Maintenance';
                        if (modalActionMessage) modalActionMessage.textContent = `${server.name}: Entering Maintenance Mode.`;
                        server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Node entered Maintenance Mode.`);
                    } else {
                        server.status = 'Running'; // Assume it goes back to running after maintenance
                        if (modalActionMessage) modalActionMessage.textContent = `${server.name}: Exiting Maintenance Mode.`;
                        server.logs.unshift(`[${new Date().toLocaleTimeString()}] [INFO] Node exited Maintenance Mode.`);
                    }
                    server.logs = server.logs.slice(0, 10);
                    saveStateToLocalStorage();
                    renderServers();
                    updateDashboardCounts();
                    showServerDetails(serverId); // Re-render modal to update status display
                });
            }

            if (serverDetailsModal) serverDetailsModal.classList.remove('hidden');
        }

        /**
         * Hides the server details modal.
         */
        function hideServerDetails() {
            if (serverDetailsModal) serverDetailsModal.classList.add('hidden');
        }

        /**
         * Renders the list of registered clients and their serial keys.
         */
        function renderClients() {
            if (clientsList) {
                clientsList.innerHTML = ''; // Clear previous list
                if (clients.length === 0) {
                    if (noClientsMessage) {
                        noClientsMessage.classList.remove('hidden');
                        clientsList.appendChild(noClientsMessage);
                    }
                } else {
                    if (noClientsMessage) noClientsMessage.classList.add('hidden');
                    clients.forEach((client, index) => {
                        const clientItem = document.createElement('div');
                        clientItem.className = `p-3 mb-2 rounded-md bg-white border border-gray-200 flex justify-between items-center ${index % 2 === 0 ? 'bg-gray-50' : ''}`;
                        clientItem.innerHTML = `
                            <div>
                                <p class="font-semibold text-gray-800">${client.name}</p>
                                <p class="text-sm text-gray-600 break-all">${client.key}</p>
                            </div>
                            <button data-key="${client.key}" class="copy-key-btn text-blue-500 hover:text-blue-700 text-lg ml-2" title="Copy Key">
                                <i class="fas fa-copy"></i>
                            </button>
                        `;
                        clientsList.appendChild(clientItem);
                    });

                    // Add event listeners for copy buttons
                    document.querySelectorAll('.copy-key-btn').forEach(button => {
                        button.addEventListener('click', (event) => {
                            const keyToCopy = event.currentTarget.dataset.key;
                            copyToClipboard(keyToCopy);
                            // Optional: Provide visual feedback
                            event.currentTarget.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                            setTimeout(() => {
                                event.currentTarget.innerHTML = '<i class="fas fa-copy"></i>';
                            }, 1500);
                        });
                    });
                }
            } else {
                console.error("Error: clientsList not found.");
            }
        }

        /**
         * Copies text to the clipboard.
         * @param {string} text The text to copy.
         */
        function copyToClipboard(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
        }

        /**
         * Generates a unique serial key from the available keys.
         * @returns {string|null} A unique serial key or null if no keys are available.
         */
        function generateUniqueKey() {
            if (availableKeys.length === 0) {
                return null; // No keys left
            }
            const randomIndex = Math.floor(Math.random() * availableKeys.length);
            const key = availableKeys[randomIndex];
            availableKeys.splice(randomIndex, 1); // Remove the used key
            return key;
        }

        /**
         * Handles the login process.
         */
        function handleLogin() {
            const enteredUsername = usernameInput.value.trim();
            const enteredPassword = passwordInput.value.trim();

            if (authMessage) {
                authMessage.textContent = 'Authenticating...';
                authMessage.classList.remove('text-red-200', 'text-yellow-200', 'text-green-700', 'glitch-text');
                authMessage.classList.add('text-blue-200');
            }


            setTimeout(() => { // Simulate network delay
                if (enteredUsername === ADMIN_USERNAME && enteredPassword === ADMIN_PASSWORD) {
                    isAuthenticated = true;
                    currentUserRole = 'admin';
                    saveStateToLocalStorage();
                    updateUIForAuthStatus();
                    if (authMessage) {
                        authMessage.textContent = 'Access Granted. Welcome, Operator.';
                        authMessage.classList.remove('text-blue-200');
                        authMessage.classList.add('text-green-700');
                    }
                    if (usernameInput) usernameInput.value = '';
                    if (passwordInput) passwordInput.value = '';
                    setTimeout(() => { if (authMessage) { authMessage.textContent = ''; authMessage.classList.remove('text-green-700'); } }, 3000);
                } else if (enteredUsername === PUBLIC_USERNAME && enteredPassword === PUBLIC_PASSWORD) {
                    isAuthenticated = true;
                    currentUserRole = 'public';
                    saveStateToLocalStorage();
                    updateUIForAuthStatus();
                    if (authMessage) {
                        authMessage.textContent = 'Public Access Granted. Welcome, Observer.';
                        authMessage.classList.remove('text-blue-200');
                        authMessage.classList.add('text-yellow-200');
                    }
                    if (usernameInput) usernameInput.value = '';
                    if (passwordInput) passwordInput.value = '';
                    setTimeout(() => { if (authMessage) { authMessage.textContent = ''; authMessage.classList.remove('text-yellow-200'); } }, 3000);
                }
                else {
                    isAuthenticated = false;
                    currentUserRole = 'guest';
                    if (authMessage) {
                        authMessage.textContent = 'Access Denied. Invalid Credentials.';
                        authMessage.classList.remove('text-blue-200');
                        authMessage.classList.add('glitch-text', 'text-red-200'); // Add glitch effect for errors
                        setTimeout(() => { if (authMessage) authMessage.classList.remove('glitch-text'); }, 1500); // Remove after a short time
                    }
                }
            }, 1000);
        }

        /**
         * Handles the logout process.
         */
        function handleLogout() {
            isAuthenticated = false;
            currentUserRole = 'guest';
            saveStateToLocalStorage();
            updateUIForAuthStatus();
            if (authMessage) {
                authMessage.textContent = 'Protocol Deactivated. Session Terminated.'; // Clear any previous messages
                authMessage.classList.remove('text-red-200', 'text-blue-200', 'glitch-text');
                authMessage.classList.add('text-yellow-200');
                setTimeout(() => { if (authMessage) { authMessage.textContent = ''; authMessage.classList.remove('text-yellow-200'); } }, 3000);
            }
        }

        /**
         * Handles adding a new client and generating a serial key.
         */
        function handleAddClient() {
            const clientName = clientNameInput.value.trim();

            if (!clientName) {
                if (keyGenMessage) {
                    keyGenMessage.textContent = 'Client identifier cannot be empty.';
                    keyGenMessage.classList.remove('text-green-600');
                    keyGenMessage.classList.add('text-red-500');
                }
                return;
            }

            // Check if client already exists
            if (clients.some(client => client.name.toLowerCase() === clientName.toLowerCase())) {
                if (keyGenMessage) {
                    keyGenMessage.textContent = 'Client with this identifier already authorized.';
                    keyGenMessage.classList.remove('text-green-600');
                    keyGenMessage.classList.add('text-red-500');
                }
                return;
            }

            const newKey = generateUniqueKey();
            if (newKey) {
                clients.push({ name: clientName, key: newKey });
                saveStateToLocalStorage();
                renderClients();
                if (clientNameInput) clientNameInput.value = ''; // Clear input
                if (keyGenMessage) {
                    keyGenMessage.textContent = 'Authorization Key Generated Successfully.';
                    keyGenMessage.classList.remove('text-red-500');
                    keyGenMessage.classList.add('text-green-600');
                    setTimeout(() => { if (keyGenMessage) { keyGenMessage.textContent = ''; keyGenMessage.classList.remove('text-green-600'); } }, 3000);
                }
            } else {
                if (keyGenMessage) {
                    keyGenMessage.textContent = 'All authorization keys have been depleted. Replenish supply.';
                    keyGenMessage.classList.remove('text-green-600');
                    keyGenMessage.classList.add('text-red-500');
                }
            }
        }

        /**
         * Updates the UI based on the authentication status and user role.
         */
        function updateUIForAuthStatus() {
            if (isAuthenticated) {
                if (loginForm) loginForm.classList.add('hidden');
                if (userInfo) {
                    userInfo.classList.remove('hidden');
                    if (displayUsername) displayUsername.textContent = currentUserRole.toUpperCase(); // Display role
                }

                if (dashboardSection) dashboardSection.classList.remove('hidden');

                if (currentUserRole === 'admin') {
                    if (serverManagementSection) serverManagementSection.classList.remove('hidden');
                    if (clientKeySection) clientKeySection.classList.remove('hidden');
                    if (publicCapabilitiesSection) publicCapabilitiesSection.classList.add('hidden'); // Hide public section
                    if (clientAddSection) clientAddSection.classList.remove('hidden'); // Admin can add clients
                } else if (currentUserRole === 'public') {
                    if (serverManagementSection) serverManagementSection.classList.add('hidden'); // Hide server operations
                    if (clientKeySection) clientKeySection.classList.add('hidden'); // Hide client management
                    if (publicCapabilitiesSection) publicCapabilitiesSection.classList.remove('hidden'); // Show public section
                }

            } else {
                if (loginForm) loginForm.classList.remove('hidden');
                if (userInfo) userInfo.classList.add('hidden');
                if (dashboardSection) dashboardSection.classList.add('hidden');
                if (serverManagementSection) serverManagementSection.classList.add('hidden');
                if (clientKeySection) clientKeySection.classList.add('hidden');
                if (publicCapabilitiesSection) publicCapabilitiesSection.classList.add('hidden'); // Hide public section on logout
            }
            renderServers(); // Re-render servers to reflect any status changes (e.g., clickability)
            updateDashboardCounts();
            renderClients(); // Re-render clients to ensure correct state display
        }

        // --- Event Listeners ---
        if (loginBtn) loginBtn.addEventListener('click', handleLogin);
        if (logoutBtn) logoutBtn.addEventListener('click', handleLogout);
        if (addClientBtn) addClientBtn.addEventListener('click', handleAddClient);

        // Allow pressing Enter in password field to login
        if (passwordInput) {
            passwordInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    handleLogin();
                }
            });
        }


        // Allow pressing Enter in client name field to add client
        if (clientNameInput) {
            clientNameInput.addEventListener('keypress', (event) => {
                if (event.key === 'Enter') {
                    handleAddClient();
                }
            });
        }


        // Forgot password link handler
        if (forgotPasswordLink) {
            forgotPasswordLink.addEventListener('click', (event) => {
                event.preventDefault();
                if (authMessage) {
                    authMessage.textContent = 'Initiating System Override Protocol... (Simulated)';
                    authMessage.classList.remove('text-red-200', 'text-blue-200');
                    authMessage.classList.add('glitch-text', 'text-yellow-200');
                    setTimeout(() => { if (authMessage) { authMessage.classList.remove('glitch-text'); authMessage.textContent = ''; authMessage.classList.remove('text-yellow-200'); } }, 4000);
                }
            });
        }


        // Close modal button
        if (closeModalBtn) closeModalBtn.addEventListener('click', hideServerDetails);

        // Close modal when clicking outside of it
        window.addEventListener('click', (event) => {
            if (event.target === serverDetailsModal) {
                hideServerDetails();
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadStateFromLocalStorage();
            updateUIForAuthStatus(); // This will trigger renderServers, updateDashboardCounts, and renderClients
        });
    </script>
</body>
</html>
